generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id                 String          @id @default(cuid())
  email         String          @unique
  password      String
  name          String
  phone         String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  lastLoginAt   DateTime?
  AdminAuditLog AdminAuditLog[]
}

model AdminAuditLog {
  id                 String          @id @default(cuid())
  adminId    String
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  Admin      Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model BottleLedger {
  id                 String          @id @default(cuid())
  customerId                  String
  action                      BottleAction
  size                        BottleSize
  quantity                    Int
  largeBottleBalanceAfter     Int
  smallBottleBalanceAfter     Int
  deliveryId                  String?
  description                 String
  issuedDate                  DateTime?
  returnedAt                  DateTime?
  penaltyAppliedAt            DateTime?
  performedByAdminId          String?
  performedByDeliveryPersonId String?
  createdAt                   DateTime     @default(now())
  Customer                    Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([customerId])
  @@index([issuedDate])
  @@index([customerId, createdAt])
  @@index([action, penaltyAppliedAt])
}

model Customer {
  id                 String          @id @default(cuid())
  email                String                 @unique
  name                 String
  phone                String                 @unique
  profileImage         String?
  addressLine1         String
  addressLine2         String?
  landmark             String?
  city                 String                 @default("Pondicherry")
  pincode              String
  status               CustomerStatus         @default(VISITOR)
  approvedAt           DateTime?
  approvedBy           String?
  rejectionReason      String?
  deliveryPersonId     String?
  deliveryNotes        String?
  createdAt            DateTime               @default(now())
  updatedAt        DateTime        @updatedAt
  deliveryStartDate    DateTime?              @db.Date
  BottleLedger         BottleLedger[]
  DeliveryPerson       DeliveryPerson?        @relation(fields: [deliveryPersonId], references: [id])
  Delivery             Delivery[]
  DeliveryModification DeliveryModification[]
  MonthlyPayment       MonthlyPayment[]
  Pause                Pause[]
  Subscription         Subscription?
  Wallet               Wallet?

  @@index([deliveryPersonId])
  @@index([phone])
  @@index([status])
  @@index([deliveryPersonId, status])
}

model Delivery {
  id                 String          @id @default(cuid())
  customerId            String
  deliveryPersonId      String?
  deliveryDate          DateTime        @db.Date
  quantityMl            Int
  largeBottles          Int
  smallBottles          Int
  chargePaise           Int
  depositPaise          Int             @default(0)
  status                DeliveryStatus  @default(SCHEDULED)
  deliveredAt           DateTime?
  largeBottlesCollected Int             @default(0)
  smallBottlesCollected Int             @default(0)
  deliveryNotes         String?
  createdAt             DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  Customer              Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  DeliveryPerson        DeliveryPerson? @relation(fields: [deliveryPersonId], references: [id])

  @@unique([customerId, deliveryDate])
  @@index([deliveryDate])
  @@index([deliveryPersonId, deliveryDate])
  @@index([deliveryPersonId, deliveryDate, status])
  @@index([status])
}

model DeliveryModification {
  id                 String          @id @default(cuid())
  customerId   String
  date         DateTime @db.Date
  quantityMl   Int
  largeBottles Int
  smallBottles Int
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt        DateTime        @updatedAt
  Customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, date])
  @@index([customerId])
  @@index([date])
}

model DeliveryPerson {
  id                 String          @id @default(cuid())
  phone            String     @unique
  password         String
  name             String
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime        @updatedAt
  lastLoginAt      DateTime?
  createdByAdminId String
  Customer         Customer[]
  Delivery         Delivery[]

  @@index([phone])
}

model Inventory {
  id                 String          @id @default(cuid())
  largeBottlesTotal         Int      @default(0)
  smallBottlesTotal         Int      @default(0)
  largeBottlesInCirculation Int      @default(0)
  smallBottlesInCirculation Int      @default(0)
  updatedAt        DateTime        @updatedAt
  updatedByAdminId          String?
}

model InventoryLog {
  id                 String          @id @default(cuid())
  action             String
  largeBottlesDelta  Int      @default(0)
  smallBottlesDelta  Int      @default(0)
  reason             String
  performedByAdminId String
  createdAt          DateTime @default(now())

  @@index([createdAt])
}

model ProductPricing {
  id                       String   @id @default(cuid())
  quantityMl               Int      @unique
  label                    String
  dailyPricePaise          Int
  largeBottleDepositPaise  Int      @default(3500)
  smallBottleDepositPaise  Int      @default(2500)
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  updatedByAdminId         String?

  @@index([isActive])
}

model Pause {
  id                 String          @id @default(cuid())
  customerId        String
  pauseDate         DateTime @db.Date
  createdByCustomer Boolean  @default(true)
  createdByAdminId  String?
  reason            String?
  createdAt         DateTime @default(now())
  Customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, pauseDate])
  @@index([customerId])
  @@index([pauseDate])
  @@index([customerId, pauseDate])
}

model PaymentOrder {
  id                String          @id @default(cuid())
  customerId        String
  paymentGateway    String        @default("CASHFREE") // CASHFREE or RAZORPAY
  gatewayOrderId    String        @unique // Cashfree order_id or Razorpay order_id
  gatewayPaymentId  String?       // Payment ID from gateway
  gatewaySignature  String?       // Signature for verification
  amountPaise       Int
  purpose           String
  status            PaymentStatus @default(PENDING)
  metadata          Json?         // Additional gateway-specific data
  createdAt         DateTime      @default(now())
  updatedAt        DateTime        @updatedAt
  completedAt       DateTime?

  @@index([customerId])
  @@index([gatewayOrderId])
  @@index([status])
}

model Session {
  id                 String          @id @default(cuid())
  sid       String   @unique
  data      String
  expiresAt DateTime
}

model Subscription {
  id                 String          @id @default(cuid())
  customerId             String             @unique
  dailyQuantityMl        Int
  dailyPricePaise        Int
  largeBotles            Int
  smallBottles           Int
  status                 SubscriptionStatus @default(PENDING)
  startDate              DateTime?
  currentCycleStart      DateTime?
  pauseDaysUsedThisMonth Int                @default(0)
  pauseMonthYear         String?
  createdAt              DateTime           @default(now())
  updatedAt        DateTime        @updatedAt
  endDate                DateTime?
  deliveryCount          Int                @default(0)
  lastDepositAtDelivery  Int                @default(0)
  lastDepositChargedAt   DateTime?
  Customer               Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([status])
}

model SystemConfig {
  id                 String          @id @default(cuid())
  key              String   @unique
  value            String
  description      String?
  updatedAt        DateTime        @updatedAt
  updatedByAdminId String?
}

model Wallet {
  id                 String          @id @default(cuid())
  customerId           String              @unique
  balancePaise         Int                 @default(0)
  negativeBalanceSince DateTime?
  createdAt            DateTime            @default(now())
  updatedAt        DateTime        @updatedAt
  Customer             Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  WalletTransaction    WalletTransaction[]

  @@index([customerId])
}

model WalletTransaction {
  id                 String          @id @default(cuid())
  walletId           String
  type               TransactionType
  amountPaise        Int
  balanceAfterPaise  Int
  description        String
  referenceId        String?
  referenceType      String?
  performedByAdminId String?
  createdAt          DateTime        @default(now())
  Wallet             Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([type])
  @@index([walletId])
  @@index([walletId, createdAt])
}

enum BottleAction {
  ISSUED
  RETURNED
  PENALTY_CHARGED
  BROKEN_REPORTED
  ADJUSTMENT
}

enum BottleSize {
  LARGE
  SMALL
}

enum CustomerStatus {
  VISITOR           // Logged in via Google but hasn't subscribed yet
  PENDING_APPROVAL  // Subscribed, waiting for admin to assign delivery person
  ACTIVE            // Has delivery person assigned and sufficient balance
  INACTIVE          // Has delivery person but insufficient wallet balance
  PAUSED            // User manually paused their subscription
}

enum DeliveryStatus {
  SCHEDULED
  DELIVERED
  NOT_DELIVERED
  PAUSED
  BLOCKED
  HOLIDAY
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  PAUSED
  EXPIRED
  CANCELLED
}

enum TransactionType {
  WALLET_TOPUP
  MONTHLY_PAYMENT
  MILK_CHARGE
  DEPOSIT_CHARGE
  PENALTY_CHARGE
  ADMIN_CREDIT
  ADMIN_DEBIT
  REFUND
  REFERRAL_CREDIT
}

enum MonthlyPaymentStatus {
  PENDING
  PAID
  OVERDUE
}

model MonthlyPayment {
  id              String               @id @default(cuid())
  customerId      String
  year            Int
  month           Int                  // 1-12
  totalCostPaise  Int                  // dailyRate * daysInMonth (full month cost)
  amountDuePaise  Int                  // totalCost - walletBalance at creation time
  amountPaidPaise Int                  @default(0)
  status          MonthlyPaymentStatus @default(PENDING)
  dueDate         DateTime             @db.Date
  paidAt          DateTime?
  paymentOrderId  String?
  isFirstMonth    Boolean              @default(false)
  startDay        Int?                 // for first month: which day deliveries start
  endDay          Int?                 // for first month: last day of month
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  Customer        Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, year, month])
  @@index([customerId])
  @@index([status])
  @@index([year, month])
}
